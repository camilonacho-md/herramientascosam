<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Visor ClÃ­nico PRAIS Â· Rayen</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:wght@400;600&family=IBM+Plex+Sans:wght@300;400;600;700&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/lz-string/1.4.4/lz-string.min.js"></script>
<style>
/* â•â• TOKENS DE TEMA â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   Toda la UI usa variables. Los dos bloques :root y [data-theme="dark"]
   son la Ãºnica fuente de verdad para colores. Nada estÃ¡ hardcodeado. */

:root {
  /* Superficie */
  --bg:          #f5f4f0;
  --bg-card:     #ffffff;
  --bg-sidebar:  #f0ede8;
  --bg-sidebar2: #e8e4de;
  --bg-input:    #ffffff;
  --bg-output:   #ffffff;

  /* Bordes */
  --border:      #dedad4;
  --border2:     #ccc8c0;
  --border-side: #d4d0c8;

  /* Texto */
  --ink:         #1a1814;
  --ink2:        #3d3a34;
  --ink3:        #6b6560;
  --ink-muted:   #9a9590;
  --ink-label:   #7a7570;

  /* Acento */
  --accent:      #1a4fff;
  --accent-soft: #e8eeff;
  --accent-hover:#0f35cc;

  /* Status */
  --ok-bg:#e8f5ee; --ok-ink:#1a5c30;
  --err-bg:#fde8e8; --err-ink:#8a0010;
  --warn-bg:#fff3e0; --warn-ink:#7a4000;

  /* Header (siempre oscuro en ambos temas) */
  --header-bg:   #18161200;

  --mono: 'IBM Plex Mono', monospace;
  --sans: 'IBM Plex Sans', sans-serif;
  --r: 6px;
}

[data-theme="dark"] {
  /* Superficie â€” tonos gris cÃ¡lido, como Claude oscuro */
  --bg:          #1e1c18;
  --bg-card:     #252220;
  --bg-sidebar:  #1a1815;
  --bg-sidebar2: #201e1a;
  --bg-input:    #161412;
  --bg-output:   #1a1815;

  /* Bordes */
  --border:      #36322c;
  --border2:     #42403a;
  --border-side: #2c2a25;

  /* Texto */
  --ink:         #e8e3db;
  --ink2:        #c0bab0;
  --ink3:        #8a847c;
  --ink-muted:   #5a5650;
  --ink-label:   #6a6560;

  /* Acento */
  --accent:      #5b8aff;
  --accent-soft: #1a2540;
  --accent-hover:#7aa0ff;

  /* Status */
  --ok-bg:#0f2018; --ok-ink:#5abf80;
  --err-bg:#201010; --err-ink:#f08080;
  --warn-bg:#201800; --warn-ink:#d4a060;
}

/* â•â• RESET & BASE â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

body {
  font-family: var(--sans);
  background: var(--bg);
  color: var(--ink);
  font-size: 14px;
  line-height: 1.6;
  min-height: 100vh;
  transition: background .25s, color .25s;
}

/* â•â• HEADER â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.site-header {
  background: #18161200;
  background: #141210;
  color: #e8e3db;
  padding: 12px 24px;
  display: flex;
  align-items: center;
  gap: 14px;
  border-bottom: 2px solid var(--accent);
  position: sticky;
  top: 0;
  z-index: 100;
}
.logo {
  font-family: var(--mono);
  font-size: 13px;
  font-weight: 600;
  letter-spacing: .08em;
  line-height: 1.3;
  color: #e8e3db;
}
.logo span {
  display: block;
  color: #6a7898;
  font-weight: 400;
  font-size: 11px;
}

/* Theme switch */
.theme-switch {
  margin-left: auto;
  display: flex;
  align-items: center;
  gap: 8px;
}
.switch-track {
  position: relative;
  width: 44px;
  height: 24px;
  background: #2a2825;
  border: 1px solid #3a3830;
  border-radius: 999px;
  cursor: pointer;
  transition: background .2s, border-color .2s;
  flex-shrink: 0;
}
.switch-track:hover { border-color: #5a5650; }
.switch-thumb {
  position: absolute;
  top: 3px;
  left: 3px;
  width: 16px;
  height: 16px;
  background: #6a6a7a;
  border-radius: 50%;
  transition: transform .2s, background .2s;
  pointer-events: none;
}
[data-theme="light"] .switch-track {
  background: #e0ddd8;
  border-color: #c8c4bc;
}
[data-theme="light"] .switch-track:hover { border-color: #a0a098; }
[data-theme="light"] .switch-thumb {
  background: var(--accent);
  transform: translateX(20px);
}
.switch-label {
  font-family: var(--mono);
  font-size: 11px;
  color: #6a7898;
  letter-spacing: .05em;
  min-width: 36px;
}

.badge {
  background: var(--accent);
  color: #fff;
  font-family: var(--mono);
  font-size: 10px;
  font-weight: 600;
  padding: 3px 9px;
  border-radius: 3px;
  letter-spacing: .1em;
  margin-left: 8px;
}

/* â•â• LAYOUT â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.layout {
  display: grid;
  grid-template-columns: 280px 1fr;
  min-height: calc(100vh - 50px);
}

/* â•â• SIDEBAR â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.sidebar {
  background: var(--bg-sidebar);
  padding: 20px 16px;
  border-right: 1px solid var(--border-side);
  display: flex;
  flex-direction: column;
  gap: 20px;
  overflow-y: auto;
  max-height: calc(100vh - 50px);
  position: sticky;
  top: 50px;
  transition: background .25s, border-color .25s;
}

.s-label {
  font-family: var(--mono);
  font-size: 10px;
  font-weight: 600;
  letter-spacing: .12em;
  color: var(--ink-label);
  text-transform: uppercase;
  padding-bottom: 5px;
  border-bottom: 1px solid var(--border);
  margin-bottom: 2px;
  transition: color .25s, border-color .25s;
}

/* Bookmarklet box */
.bm-box {
  background: var(--bg-sidebar2);
  border: 1px solid var(--border);
  border-radius: var(--r);
  padding: 12px;
  display: flex;
  flex-direction: column;
  gap: 8px;
  transition: background .25s, border-color .25s;
}
.bm-link {
  display: block;
  background: var(--accent);
  color: #fff;
  text-decoration: none;
  font-family: var(--mono);
  font-size: 12px;
  font-weight: 600;
  padding: 9px 12px;
  border-radius: 4px;
  text-align: center;
  cursor: grab;
  transition: background .15s;
  user-select: none;
}
.bm-link:hover { background: var(--accent-hover); }
.bm-steps { display: flex; flex-direction: column; gap: 4px; }
.bm-step {
  color: var(--ink-muted);
  font-size: 11px;
  display: flex;
  gap: 5px;
  line-height: 1.45;
}
.bm-step b { color: var(--accent); flex-shrink: 0; font-family: var(--mono); }

/* BotÃ³n portapapeles */
.btn-clipboard {
  background: linear-gradient(135deg, var(--accent), #0b2db0);
  color: #fff;
  border: none;
  border-radius: 6px;
  padding: 11px 16px;
  font-family: var(--mono);
  font-size: 13px;
  font-weight: 600;
  cursor: pointer;
  width: 100%;
  transition: .2s;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 8px;
  box-shadow: 0 3px 12px rgba(26,79,255,.3);
}
.btn-clipboard:hover { filter: brightness(1.12); transform: translateY(-1px); }
.btn-clipboard:active { transform: translateY(0); }
.btn-clipboard:disabled { opacity: .35; cursor: not-allowed; transform: none; }

.btn-primary {
  background: var(--accent);
  color: #fff;
  border: none;
  border-radius: 4px;
  padding: 9px 16px;
  font-family: var(--mono);
  font-size: 12px;
  font-weight: 600;
  cursor: pointer;
  width: 100%;
  transition: background .15s;
}
.btn-primary:hover { background: var(--accent-hover); }
.btn-primary:disabled { opacity: .3; cursor: not-allowed; }

.btn-sec {
  background: var(--bg-card);
  color: var(--ink3);
  border: 1px solid var(--border);
  border-radius: 4px;
  padding: 7px 12px;
  font-family: var(--mono);
  font-size: 11px;
  cursor: pointer;
  width: 100%;
  transition: .15s;
}
.btn-sec:hover { border-color: var(--accent); color: var(--accent); }

/* Inputs */
select.ui-select {
  background: var(--bg-input);
  border: 1px solid var(--border);
  color: var(--ink);
  border-radius: 4px;
  padding: 6px 8px;
  font-size: 12px;
  font-family: var(--sans);
  width: 100%;
  outline: none;
  transition: background .25s, border-color .15s, color .25s;
}
select.ui-select[multiple] { height: 88px; }
select.ui-select:focus { border-color: var(--accent); }

.filter-group { display: flex; flex-direction: column; gap: 3px; }
.filter-group label { color: var(--ink-label); font-size: 11px; font-family: var(--mono); }

.check-row { display: flex; align-items: center; gap: 6px; cursor: pointer; }
.check-row input { accent-color: var(--accent); }
.check-row label { color: var(--ink3); font-size: 12px; cursor: pointer; }
.fields-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 2px 8px; }
.fields-grid .check-row label { font-size: 11px; }

.paste-area {
  background: var(--bg-input);
  border: 1px solid var(--border);
  border-radius: 4px;
  padding: 8px;
  font-family: var(--mono);
  font-size: 11px;
  color: var(--ink);
  resize: vertical;
  height: 68px;
  width: 100%;
  outline: none;
  line-height: 1.4;
  transition: background .25s, border-color .15s, color .25s;
}
.paste-area:focus { border-color: var(--accent); }
.paste-area::placeholder { color: var(--ink-muted); }

/* Status */
.status-bar {
  font-family: var(--mono);
  font-size: 11px;
  padding: 7px 10px;
  border-radius: 4px;
  display: none;
  line-height: 1.4;
}
.status-bar.ok   { background: var(--ok-bg);   color: var(--ok-ink);   display: block; }
.status-bar.err  { background: var(--err-bg);  color: var(--err-ink);  display: block; }
.status-bar.warn { background: var(--warn-bg); color: var(--warn-ink); display: block; }
.counter { font-family: var(--mono); font-size: 11px; color: var(--ink-muted); text-align: center; padding: 2px 0; }
.counter b { color: var(--ink3); }

/* Tags */
.add-field-row { display: flex; gap: 5px; margin-top: 4px; }
.add-field-row input {
  flex: 1;
  background: var(--bg-input);
  border: 1px solid var(--border);
  color: var(--ink);
  border-radius: 4px;
  padding: 5px 7px;
  font-family: var(--mono);
  font-size: 11px;
  outline: none;
  transition: background .25s, border-color .15s, color .25s;
}
.add-field-row input:focus { border-color: var(--accent); }
.add-field-row input::placeholder { color: var(--ink-muted); }
.add-field-row button {
  background: var(--bg-card);
  border: 1px solid var(--border);
  color: var(--ink3);
  border-radius: 4px;
  padding: 5px 9px;
  font-size: 11px;
  cursor: pointer;
  white-space: nowrap;
  transition: .15s;
}
.add-field-row button:hover { background: var(--accent); color: #fff; border-color: var(--accent); }
.tag-list { display: flex; flex-wrap: wrap; gap: 4px; margin-top: 5px; }
.tag {
  display: inline-flex;
  align-items: center;
  gap: 3px;
  background: var(--accent-soft);
  color: var(--accent);
  border-radius: 999px;
  padding: 2px 7px;
  font-family: var(--mono);
  font-size: 10px;
}
.tag button {
  background: none;
  border: none;
  color: var(--ink-muted);
  cursor: pointer;
  font-size: 11px;
  padding: 0 1px;
  line-height: 1;
}
.tag button:hover { color: var(--err-ink); }

/* â•â• MAIN â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.main-area { display: flex; flex-direction: column; background: var(--bg-output); transition: background .25s; }

.main-toolbar {
  background: var(--bg-card);
  border-bottom: 1px solid var(--border);
  padding: 8px 20px;
  display: flex;
  align-items: center;
  gap: 10px;
  transition: background .25s, border-color .25s;
}
.tabs {
  display: flex;
  gap: 2px;
  background: var(--bg);
  border-radius: 5px;
  padding: 3px;
  transition: background .25s;
}
.tab-btn {
  background: none;
  border: none;
  border-radius: 3px;
  padding: 5px 14px;
  font-family: var(--mono);
  font-size: 12px;
  font-weight: 600;
  color: var(--ink3);
  cursor: pointer;
  transition: .15s;
}
.tab-btn.active {
  background: var(--bg-card);
  color: var(--accent);
  box-shadow: 0 1px 3px rgba(0,0,0,.08);
}
.copy-btn {
  margin-left: auto;
  background: var(--bg);
  border: 1px solid var(--border2);
  border-radius: 4px;
  padding: 5px 12px;
  font-family: var(--mono);
  font-size: 11px;
  font-weight: 600;
  color: var(--ink2);
  cursor: pointer;
  transition: .15s;
}
.copy-btn:hover { background: var(--accent-soft); color: var(--accent); border-color: var(--accent); }

.output-wrap { flex: 1; display: flex; flex-direction: column; }
.tab-content { display: none; flex: 1; flex-direction: column; }
.tab-content.active { display: flex; }

textarea.output {
  flex: 1;
  font-family: var(--mono);
  font-size: 12px;
  line-height: 1.75;
  background: var(--bg-output);
  border: none;
  outline: none;
  padding: 24px;
  resize: none;
  color: var(--ink);
  min-height: calc(100vh - 108px);
  transition: background .25s, color .25s;
}

/* Welcome */
.welcome {
  flex: 1;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  padding: 60px 40px;
  text-align: center;
  gap: 14px;
  color: var(--ink3);
}
.welcome-icon { font-size: 44px; opacity: .18; line-height: 1; }
.welcome h2 { font-size: 17px; font-weight: 600; color: var(--ink2); }
.welcome p { max-width: 380px; font-size: 13px; line-height: 1.7; }
.welcome code {
  font-family: var(--mono);
  background: var(--bg-sidebar2);
  border: 1px solid var(--border);
  padding: 2px 5px;
  border-radius: 3px;
  font-size: 11px;
}

/* Spinner */
@keyframes spin { to { transform: rotate(360deg); } }
.spinner {
  width: 13px; height: 13px;
  border: 2px solid rgba(255,255,255,.3);
  border-top-color: #fff;
  border-radius: 50%;
  animation: spin .7s linear infinite;
  flex-shrink: 0;
}
</style>
</head>

<!-- Aplicar tema antes del render para evitar flash -->
<script>
(function(){
  const t = localStorage.getItem('rayen_theme') || 'dark';
  document.documentElement.setAttribute('data-theme', t);
})();
</script>

<body>

<header class="site-header">
  <div class="logo">VISOR CLÃNICO<span>PRAIS Â· Rayen â†’ LLM</span></div>

  <!-- Switch tema -->
  <div class="theme-switch">
    <span class="switch-label" id="themeLabel">oscuro</span>
    <div class="switch-track" id="themeToggle" role="button" tabindex="0" title="Cambiar tema">
      <div class="switch-thumb"></div>
    </div>
  </div>

  <div class="badge">SSO Â· COSAM</div>
</header>

<div class="layout">

  <!-- â•â•â• SIDEBAR â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <aside class="sidebar">

    <div>
      <div class="s-label">01 Â· Interceptor Rayen</div>
      <div class="bm-box">
        <a class="bm-link" id="bookmarkletLink" href="javascript:void(0)" title="Arrastra a la barra de favoritos">
          ğŸ“¡ Rayen Capturar
        </a>
        <div class="bm-steps">
          <div class="bm-step"><b>â‘ </b> Arrastra el botÃ³n a la barra de favoritos.</div>
          <div class="bm-step"><b>â‘¡</b> Abre Rayen â†’ historial del paciente.</div>
          <div class="bm-step"><b>â‘¢</b> Clic en el favorito â†’ panel flotante.</div>
          <div class="bm-step"><b>â‘£</b> Navega a la ficha. El interceptor captura.</div>
          <div class="bm-step"><b>â‘¤</b> Clic en <b>"ğŸ“‹ Copiar datos"</b> en el panel.</div>
          <div class="bm-step"><b>â‘¥</b> Vuelve aquÃ­ y presiona el botÃ³n azul abajo.</div>
        </div>
      </div>
    </div>

    <div>
      <div class="s-label">02 Â· Cargar datos</div>
      <button class="btn-clipboard" id="btnClipboard">
        <span id="clipIcon">ğŸ“‹</span>
        <span id="clipText">Leer desde portapapeles</span>
      </button>
      <div style="margin-top:10px">
        <div class="s-label" style="margin-bottom:5px">fallback Â· pegar JSON</div>
        <textarea class="paste-area" id="pasteArea" placeholder="Pegar JSON aquÃ­ si el portapapeles falla..."></textarea>
        <button class="btn-sec" style="margin-top:5px" id="parsePaste">Parsear texto pegado</button>
      </div>
    </div>

    <div id="statusBar" class="status-bar"></div>
    <div id="counter" class="counter" style="display:none"></div>

    <div>
      <div class="s-label">03 Â· Filtros</div>
      <div style="display:flex;flex-direction:column;gap:8px">
        <div class="filter-group">
          <label>Instrumento</label>
          <select class="ui-select" id="instrumentos" multiple></select>
        </div>
        <div class="filter-group">
          <label>Profesional</label>
          <select class="ui-select" id="profesionales" multiple></select>
        </div>
        <div class="check-row" style="margin-top:4px">
          <input type="checkbox" id="excluirAbreviada">
          <label for="excluirAbreviada">Excluir consultas abreviadas</label>
        </div>
        <div class="check-row">
          <input type="checkbox" id="excluirVacios" checked>
          <label for="excluirVacios">Excluir registros sin anamnesis</label>
        </div>
      </div>
    </div>

    <div>
      <div class="s-label">04 Â· Campos a incluir</div>
      <div class="fields-grid">
        <div class="check-row"><input type="checkbox" name="campo" value="Fecha" checked><label>Fecha</label></div>
        <div class="check-row"><input type="checkbox" name="campo" value="NombreCompleto" checked><label>Paciente</label></div>
        <div class="check-row"><input type="checkbox" name="campo" value="RutPaciente" checked><label>RUT</label></div>
        <div class="check-row"><input type="checkbox" name="campo" value="FechaNacimiento" checked><label>Nacimiento</label></div>
        <div class="check-row"><input type="checkbox" name="campo" value="Profesional" checked><label>Profesional</label></div>
        <div class="check-row"><input type="checkbox" name="campo" value="Diagnosticos" checked><label>DiagnÃ³sticos</label></div>
        <div class="check-row"><input type="checkbox" name="campo" value="Actividades" checked><label>Actividades</label></div>
        <div class="check-row"><input type="checkbox" name="campo" value="Prescripciones" checked><label>Prescripciones</label></div>
        <div class="check-row"><input type="checkbox" name="campo" value="MotivoConsulta" checked><label>Motivo</label></div>
        <div class="check-row"><input type="checkbox" name="campo" value="Historia" checked><label>Historia</label></div>
      </div>
      <div style="margin-top:8px">
        <div style="color:var(--ink-muted);font-size:10px;font-family:var(--mono);margin-bottom:3px">CAMPO EXTRA</div>
        <div class="add-field-row">
          <input type="text" id="campoDinamico" placeholder="ej: Indicaciones[].Texto">
          <button id="agregarCampo">+ Add</button>
        </div>
        <div class="tag-list" id="camposExtra"></div>
      </div>
    </div>

    <div>
      <button class="btn-primary" id="generar" disabled>âš™ Generar salida</button>
    </div>

  </aside>

  <!-- â•â•â• MAIN â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <main class="main-area">
    <div class="main-toolbar">
      <div class="tabs">
        <button class="tab-btn active" data-tab="md">Markdown</button>
        <button class="tab-btn" data-tab="json">JSON</button>
      </div>
      <button class="copy-btn" id="copyBtn">ğŸ“‹ Copiar</button>
    </div>
    <div class="output-wrap">
      <div id="welcome" class="welcome">
        <div class="welcome-icon">âš•</div>
        <h2>Sin datos cargados</h2>
        <p>Instala el bookmarklet, captura el historial en Rayen con <code>ğŸ“‹ Copiar datos</code>, luego presiona <code>Leer desde portapapeles</code>.</p>
      </div>
      <div id="tab-md" class="tab-content active" style="display:none">
        <textarea class="output" id="outputMD" readonly></textarea>
      </div>
      <div id="tab-json" class="tab-content" style="display:none">
        <textarea class="output" id="outputJSON" readonly></textarea>
      </div>
    </div>
  </main>

</div>

<script>
const $ = id => document.getElementById(id);
const ESTADO_DX = {0:'Ninguno',1:'Sospecha',2:'Confirmada',3:'Descartada'};
let datos = [], camposExtraList = [];

/* â”€â”€ Tema â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function getTheme() { return document.documentElement.getAttribute('data-theme') || 'dark'; }
function setTheme(t) {
  document.documentElement.setAttribute('data-theme', t);
  localStorage.setItem('rayen_theme', t);
  $('themeLabel').textContent = t === 'dark' ? 'oscuro' : 'claro';
}
// Inicializar label
setTheme(getTheme());

$('themeToggle').addEventListener('click', () => setTheme(getTheme() === 'dark' ? 'light' : 'dark'));
$('themeToggle').addEventListener('keydown', e => { if (e.key===' '||e.key==='Enter') { e.preventDefault(); $('themeToggle').click(); } });

/* â”€â”€ Utilidades â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function formatFecha(v) {
  if (!v) return '';
  const s = (v+'').replace(/\s.*/,'');
  if (/^\d{8}$/.test(s)) return `${s.slice(6,8)}-${s.slice(4,6)}-${s.slice(0,4)}`;
  return v;
}
function formatHora(v) {
  if (!v) return '';
  const m = (v+'').match(/\d{8}\s(\d{2})(\d{2})/);
  return m ? `${m[1]}:${m[2]}` : '';
}
function getPath(obj, ruta) {
  let res = [obj];
  for (const p of ruta.split('.')) {
    const isArr = p.endsWith('[]');
    const key = isArr ? p.slice(0,-2) : p;
    res = res.flatMap(e => {
      if (!e || !(key in e)) return [];
      const val = e[key];
      if (isArr && Array.isArray(val)) return val;
      return isArr ? [] : [val];
    });
  }
  return res.filter(v => v !== undefined && v !== null && v !== '');
}
function uniq(a) { return [...new Set(a)]; }
function instrDeReg(r) { return uniq(getPath(r,'Actividades[].Instrumento').concat(getPath(r,'FuncionariosPrestadores[].NombreInstrumento'))); }
function profsDeReg(r) { return uniq(getPath(r,'FuncionariosPrestadores[].NombreCompleto')); }
function setStatus(msg, tipo) { const el=$('statusBar'); el.textContent=msg; el.className='status-bar '+tipo; }
function updateCounter(t,f) { $('counter').innerHTML=`cargados <b>${t}</b> Â· filtrados <b>${f}</b>`; $('counter').style.display='block'; }

/* â”€â”€ Bookmarklet â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
(function() {
  const code = `(function(){
function run(){
  if(window.__rayenActive){if(window.__rayenUI)window.__rayenUI.style.display='flex';return;}
  window.__rayenActive=true;window.__rayenData=[];
  var _f=window.fetch;
  window.fetch=function(){
    var a=arguments;
    return _f.apply(this,a).then(function(r){
      var url=(a[0]&&a[0].url)||a[0]||'';
      if((url+'').indexOf('HistorialAtencion')>-1){
        r.clone().json().then(function(d){
          var arr=Array.isArray(d)?d:[d];
          window.__rayenData=arr;
          if(window.__rayenBadge)window.__rayenBadge.textContent=window.__rayenData.length+' reg';
        }).catch(function(){});
      }
      return r;
    });
  };
  var ui=document.createElement('div');
  window.__rayenUI=ui;
  ui.style.cssText='position:fixed;bottom:20px;right:20px;z-index:2147483647;background:#1a1815;border:2px solid #5b8aff;border-radius:10px;padding:10px 14px;font-family:monospace;font-size:12px;color:#e8e3db;display:flex;align-items:center;gap:10px;box-shadow:0 4px 24px rgba(0,0,0,.7)';
  var lbl=document.createElement('span');lbl.style.color='#6a7898';lbl.textContent='ğŸ“¡ Rayen';
  var badge=document.createElement('span');
  badge.style.cssText='background:#5b8aff;color:#fff;padding:2px 9px;border-radius:999px;font-size:11px;font-weight:700';
  badge.textContent='0 reg';window.__rayenBadge=badge;
  var btn=document.createElement('button');
  btn.textContent='ğŸ“‹ Copiar datos';
  btn.style.cssText='background:#5b8aff;border:none;color:#fff;padding:6px 12px;border-radius:5px;cursor:pointer;font-family:monospace;font-size:12px;font-weight:700';
  btn.onclick=function(){
    if(!window.__rayenData.length){alert('Sin datos. Navega al historial primero.');return;}
    var compressed=LZString.compressToBase64(JSON.stringify(window.__rayenData));
    navigator.clipboard.writeText(compressed).then(function(){
      btn.textContent='âœ… Copiado ('+window.__rayenData.length+' reg)';
      setTimeout(function(){btn.textContent='ğŸ“‹ Copiar datos';},3000);
    }).catch(function(){
      window.prompt('Copia manualmente (Ctrl+A, Ctrl+C):',compressed);
    });
  };
  var x=document.createElement('button');
  x.textContent='âœ•';x.style.cssText='background:none;border:none;color:#5a5650;cursor:pointer;font-size:14px;padding:0 2px;line-height:1';
  x.onclick=function(){ui.style.display='none';};
  ui.appendChild(lbl);ui.appendChild(badge);ui.appendChild(btn);ui.appendChild(x);
  document.body.appendChild(ui);
}
if(window.LZString){run();}else{
  var s=document.createElement('script');
  s.src='https://cdnjs.cloudflare.com/ajax/libs/lz-string/1.4.4/lz-string.min.js';
  s.onload=run;document.head.appendChild(s);
}
})()`;
  $('bookmarkletLink').href = 'javascript:' + code.replace(/\n\s+/g,' ');
})();

/* â”€â”€ Parse â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function tryDecompress(txt) {
  try {
    const dec = LZString.decompressFromBase64(txt);
    if (dec && (dec[0]==='[' || dec[0]==='{')) return dec;
  } catch(e) {}
  return txt;
}
function parsear(txt, autoGenerar) {
  try {
    const source = tryDecompress(txt.trim());
    const d = JSON.parse(source);
    datos = Array.isArray(d) ? d : [d];
    poblarFiltros(datos);
    setStatus(`âœ… ${datos.length} registros cargados`, 'ok');
    $('counter').style.display = 'none';
    $('generar').disabled = false;
    if (autoGenerar) generar();
  } catch(e) {
    setStatus('âŒ ' + e.message, 'err');
  }
}
function poblarFiltros(json) {
  const ins = new Set(), pros = new Set();
  json.forEach(r => { instrDeReg(r).forEach(i=>ins.add(i)); profsDeReg(r).forEach(p=>pros.add(p)); });
  const build = (sel, set) => {
    sel.innerHTML = '';
    [...set].sort().forEach(v => { const o=document.createElement('option'); o.value=o.textContent=v; sel.appendChild(o); });
  };
  build($('instrumentos'), ins);
  build($('profesionales'), pros);
}

/* â”€â”€ Leer portapapeles â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
$('btnClipboard').addEventListener('click', async () => {
  const icon=$('clipIcon'), txt=$('clipText'), btn=$('btnClipboard');
  icon.className='spinner'; icon.textContent='';
  txt.textContent='Leyendo...'; btn.disabled=true;
  try {
    const raw = await navigator.clipboard.readText();
    if (!raw||!raw.trim()) throw new Error('Portapapeles vacÃ­o');
    parsear(raw.trim(), true);
    icon.className=''; icon.textContent='âœ…'; txt.textContent='Datos cargados';
    setTimeout(()=>{ icon.textContent='ğŸ“‹'; txt.textContent='Leer desde portapapeles'; btn.disabled=false; }, 2500);
  } catch(e) {
    setStatus('âš ï¸ '+(e.name==='NotAllowedError' ? 'Permiso denegado. Usa el fallback manual abajo.' : e.message), 'warn');
    icon.className=''; icon.textContent='ğŸ“‹'; txt.textContent='Leer desde portapapeles'; btn.disabled=false;
  }
});

/* â”€â”€ Generar â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function generar() {
  const sel = new Set([...document.querySelectorAll('input[name="campo"]:checked')].map(c=>c.value));
  const filtInstr = [...$('instrumentos').selectedOptions].map(o=>o.value);
  const filtProfs = [...$('profesionales').selectedOptions].map(o=>o.value);
  const excluirAbr = $('excluirAbreviada').checked;
  const excluirVacios = $('excluirVacios').checked;

  const filtrados = datos.filter(r => {
    if (filtInstr.length && !instrDeReg(r).some(i=>filtInstr.includes(i))) return false;
    if (filtProfs.length && !profsDeReg(r).some(p=>filtProfs.includes(p))) return false;
    if (excluirAbr) {
      const descs = getPath(r,'Actividades[].Descripcion').map(d=>(d+'').toLowerCase());
      if (descs.some(d=>d.includes('consulta abreviada'))) return false;
    }
    if (excluirVacios) {
      const hda = getPath(r,'Anamnesis[].HistoriaEnfermedadActual').filter(x=>x&&x.trim());
      const mot = getPath(r,'Anamnesis[].MotivoConsulta').filter(x=>x&&x.trim());
      if (!hda.length && !mot.length) return false;
    }
    return true;
  });

  updateCounter(datos.length, filtrados.length);

  const porPaciente = new Map();
  filtrados.forEach(r => {
    const k = r.RutPaciente || r.NombreCompleto || '(sin paciente)';
    if (!porPaciente.has(k)) porPaciente.set(k,[]);
    porPaciente.get(k).push(r);
  });

  let md = '';
  const jsonOut = [];

  for (const [, regs] of porPaciente) {
    regs.sort((a,b)=>(a.Fecha||'').localeCompare(b.Fecha||''));
    const nombre = regs[0].NombreCompleto || '(sin nombre)';
    const rut    = regs[0].RutPaciente || '';
    const fnac   = formatFecha(regs[0].FechaNacimiento || '');

    let header = `## ${nombre}`;
    if (sel.has('RutPaciente') && rut) header += ` Â· RUT ${rut}`;
    if (sel.has('FechaNacimiento') && fnac) header += ` Â· Nac. ${fnac}`;
    md += header + '\n\n';

    const atenciones = [];
    regs.forEach(reg => {
      const fecha      = formatFecha(reg.Fecha||'');
      const hora       = formatHora(reg.Fecha||'');
      const profNombre = getPath(reg,'FuncionariosPrestadores[].NombreCompleto')[0]||'';
      const profProf   = getPath(reg,'FuncionariosPrestadores[].NombreInstrumento')[0]||'';
      const actDescs   = getPath(reg,'Actividades[].Descripcion');

      const dxObjs = (reg.Diagnosticos||[]).filter(d=>d.DescripcionClasificacion && d.DescripcionClasificacion!=='No Informado');
      const diagnosticos = dxObjs.map(d => {
        const est = ESTADO_DX[d.Estado];
        return (est && est!=='Ninguno') ? `${d.DescripcionClasificacion} (${est})` : d.DescripcionClasificacion;
      }).join(', ');

      const prescripciones = (reg.Prescripciones||[]).map(p=>p.Descripcion).filter(Boolean).join(' | ');
      const motivo = getPath(reg,'Anamnesis[].MotivoConsulta').join(' ');
      const hda    = getPath(reg,'Anamnesis[].HistoriaEnfermedadActual').join('\n');

      let h3 = `### ${fecha||'(sin fecha)'}`;
      if (hora) h3 += ` ${hora}`;
      if (sel.has('Profesional') && profNombre) {
        h3 += ` â€” ${profNombre}`;
        if (profProf) h3 += ` (${profProf})`;
      }
      md += h3 + '\n';

      if (sel.has('Diagnosticos')   && diagnosticos)    md += `- **Dx:** ${diagnosticos}\n`;
      if (sel.has('Actividades')    && actDescs.length) md += `- **Actividades:** ${actDescs.join(', ')}\n`;
      if (sel.has('Prescripciones') && prescripciones)  md += `- **Prescripciones:** ${prescripciones}\n`;
      if (sel.has('MotivoConsulta') && motivo)          md += `- **Motivo:** ${motivo}\n`;
      if (sel.has('Historia')       && hda)             md += `- **Historia:** ${hda}\n`;

      camposExtraList.forEach(ruta => {
        const vals = getPath(reg, ruta);
        if (vals.length) md += `- **${ruta}:** ${vals.join(' | ')}\n`;
      });
      md += '\n';

      const at = {};
      if (sel.has('Fecha'))          { at.Fecha=fecha; if(hora) at.Hora=hora; }
      if (sel.has('Profesional'))    { at.Profesional=profNombre||null; at.Profesion=profProf||null; }
      if (sel.has('Diagnosticos'))   at.Diagnosticos = dxObjs.map(d=>({descripcion:d.DescripcionClasificacion, estado:ESTADO_DX[d.Estado]||''}));
      if (sel.has('Actividades'))    at.Actividades = actDescs;
      if (sel.has('Prescripciones')) at.Prescripciones = prescripciones ? prescripciones.split(' | ') : [];
      if (sel.has('MotivoConsulta')) at.MotivoConsulta = motivo||null;
      if (sel.has('Historia'))       at.Historia = hda||null;
      camposExtraList.forEach(r => { at[r]=getPath(reg,r); });
      atenciones.push(at);
    });

    jsonOut.push({NombreCompleto:nombre, RutPaciente:rut||null, FechaNacimiento:fnac||null, Atenciones:atenciones});
    md += '---\n\n';
  }

  $('outputMD').value   = md.trim();
  $('outputJSON').value = JSON.stringify(jsonOut, null, 2);
  $('welcome').style.display = 'none';
  const activeTab = document.querySelector('.tab-btn.active').dataset.tab;
  document.querySelectorAll('.tab-content').forEach(c=>c.style.display='none');
  $('tab-'+activeTab).style.display = 'flex';
}

/* â”€â”€ Copiar output â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
async function copiar(texto, btn) {
  try {
    await navigator.clipboard.writeText(texto);
    const orig=btn.textContent; btn.textContent='âœ… Copiado';
    setTimeout(()=>btn.textContent=orig, 2000);
  } catch { btn.textContent='âš ï¸ Error'; }
}

/* â”€â”€ Campos extra â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function renderTags() {
  $('camposExtra').innerHTML = '';
  camposExtraList.forEach((c,i) => {
    const d=document.createElement('div'); d.className='tag';
    d.innerHTML=`${c} <button onclick="quitarCampo(${i})">âœ•</button>`;
    $('camposExtra').appendChild(d);
  });
}
window.quitarCampo = i => { camposExtraList.splice(i,1); renderTags(); };
$('agregarCampo').addEventListener('click', () => {
  const v=$('campoDinamico').value.trim();
  if (v && !camposExtraList.includes(v)){ camposExtraList.push(v); renderTags(); $('campoDinamico').value=''; }
});

/* â”€â”€ Eventos â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
$('parsePaste').addEventListener('click', () => {
  const t=$('pasteArea').value.trim();
  if (!t){ setStatus('âš ï¸ No hay contenido.','warn'); return; }
  parsear(t, false);
});
$('generar').addEventListener('click', generar);
$('copyBtn').addEventListener('click', () => {
  const tab = document.querySelector('.tab-btn.active').dataset.tab;
  copiar(tab==='md' ? $('outputMD').value : $('outputJSON').value, $('copyBtn'));
});
document.querySelectorAll('.tab-btn').forEach(btn => btn.addEventListener('click', () => {
  document.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('active'));
  btn.classList.add('active');
  if ($('welcome').style.display==='none') {
    document.querySelectorAll('.tab-content').forEach(c=>c.style.display='none');
    $('tab-'+btn.dataset.tab).style.display='flex';
  }
}));
</script>
</body>
</html>
