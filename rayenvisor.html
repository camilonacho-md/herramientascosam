<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Visor Cl√≠nico PRAIS ¬∑ Rayen</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:wght@400;600&family=IBM+Plex+Sans:wght@300;400;600;700&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/lz-string/1.4.4/lz-string.min.js"></script>
<style>
:root {
  --ink:#0f1117; --ink2:#3a3f4d; --ink3:#6b7280;
  --paper:#f5f4f0; --card:#ffffff;
  --accent:#1a4fff; --accent-soft:#e8eeff;
  --border:#e2e0db; --border2:#d0cec8;
  --mono:'IBM Plex Mono',monospace;
  --sans:'IBM Plex Sans',sans-serif;
  --r:6px;
}
*{box-sizing:border-box;margin:0;padding:0}
body{font-family:var(--sans);background:var(--paper);color:var(--ink);font-size:14px;line-height:1.6;min-height:100vh}

.site-header{background:var(--ink);color:#fff;padding:13px 28px;display:flex;align-items:center;gap:16px;border-bottom:3px solid var(--accent)}
.logo{font-family:var(--mono);font-size:13px;font-weight:600;letter-spacing:.08em;line-height:1.3}
.logo span{display:block;color:#8899cc;font-weight:400;font-size:11px}
.badge{margin-left:auto;background:var(--accent);color:#fff;font-family:var(--mono);font-size:10px;font-weight:600;padding:3px 9px;border-radius:3px;letter-spacing:.1em}

.layout{display:grid;grid-template-columns:280px 1fr;min-height:calc(100vh - 52px)}

.sidebar{background:#080b12;padding:20px 16px;border-right:1px solid #141928;display:flex;flex-direction:column;gap:20px;overflow-y:auto;max-height:calc(100vh - 52px);position:sticky;top:0}
.s-label{font-family:var(--mono);font-size:10px;font-weight:600;letter-spacing:.12em;color:#2e3650;text-transform:uppercase;padding-bottom:5px;border-bottom:1px solid #141928;margin-bottom:2px}

.bm-box{background:#0d1120;border:1px solid #1a2035;border-radius:var(--r);padding:12px;display:flex;flex-direction:column;gap:8px}
.bm-link{display:block;background:var(--accent);color:#fff;text-decoration:none;font-family:var(--mono);font-size:12px;font-weight:600;padding:9px 12px;border-radius:4px;text-align:center;cursor:grab;transition:background .15s;user-select:none}
.bm-link:hover{background:#0f35cc}
.bm-steps{display:flex;flex-direction:column;gap:4px}
.bm-step{color:#4a5470;font-size:11px;display:flex;gap:5px;line-height:1.45}
.bm-step b{color:#3355bb;flex-shrink:0;font-family:var(--mono)}

.btn-clipboard{background:linear-gradient(135deg,#1a4fff,#0b2db0);color:#fff;border:none;border-radius:6px;padding:12px 16px;font-family:var(--mono);font-size:13px;font-weight:600;cursor:pointer;width:100%;transition:.2s;letter-spacing:.03em;display:flex;align-items:center;justify-content:center;gap:8px;box-shadow:0 3px 12px rgba(26,79,255,.35)}
.btn-clipboard:hover{background:linear-gradient(135deg,#0f35cc,#07228a);transform:translateY(-1px);box-shadow:0 5px 18px rgba(26,79,255,.45)}
.btn-clipboard:active{transform:translateY(0)}
.btn-clipboard:disabled{opacity:.35;cursor:not-allowed;transform:none}

.btn-primary{background:var(--accent);color:#fff;border:none;border-radius:4px;padding:9px 16px;font-family:var(--mono);font-size:12px;font-weight:600;cursor:pointer;width:100%;transition:background .15s}
.btn-primary:hover{background:#0f35cc}
.btn-primary:disabled{opacity:.3;cursor:not-allowed}
.btn-sec{background:#111828;color:#4a5470;border:1px solid #1a2035;border-radius:4px;padding:7px 12px;font-family:var(--mono);font-size:11px;cursor:pointer;width:100%;transition:.15s}
.btn-sec:hover{background:#1a2035;color:#8899cc}

.status-bar{font-family:var(--mono);font-size:11px;padding:7px 10px;border-radius:4px;display:none;line-height:1.4}
.status-bar.ok{background:#071a0f;color:#4caf88;display:block}
.status-bar.err{background:#1a0709;color:#f77;display:block}
.status-bar.warn{background:#1a1200;color:#ffa733;display:block}
.counter{font-family:var(--mono);font-size:11px;color:#2e3650;text-align:center;padding:2px 0}
.counter b{color:#4a5a80}

select.dark{background:#0d1120;border:1px solid #1a2035;color:#c8d0e8;border-radius:4px;padding:6px 8px;font-size:12px;font-family:var(--sans);width:100%;outline:none}
select.dark[multiple]{height:88px}
select.dark:focus{border-color:var(--accent)}
select.dark option{background:#0d1120}
.filter-group{display:flex;flex-direction:column;gap:3px}
.filter-group label{color:#4a5470;font-size:11px;font-family:var(--mono)}
.check-row{display:flex;align-items:center;gap:6px;cursor:pointer}
.check-row input{accent-color:var(--accent)}
.check-row label{color:#4a5470;font-size:12px;cursor:pointer}
.fields-grid{display:grid;grid-template-columns:1fr 1fr;gap:2px 8px}
.fields-grid .check-row label{font-size:11px}

.paste-area{background:#0d1120;border:1px solid #1a2035;border-radius:4px;padding:8px;font-family:var(--mono);font-size:11px;color:#8899cc;resize:vertical;height:68px;width:100%;outline:none;line-height:1.4}
.paste-area:focus{border-color:var(--accent)}

.add-field-row{display:flex;gap:5px;margin-top:4px}
.add-field-row input{flex:1;background:#0d1120;border:1px solid #1a2035;color:#c8d0e8;border-radius:4px;padding:5px 7px;font-family:var(--mono);font-size:11px;outline:none}
.add-field-row input:focus{border-color:var(--accent)}
.add-field-row button{background:#1a2035;border:1px solid #1a2035;color:#8899cc;border-radius:4px;padding:5px 9px;font-size:11px;cursor:pointer;white-space:nowrap}
.add-field-row button:hover{background:var(--accent);color:#fff;border-color:var(--accent)}
.tag-list{display:flex;flex-wrap:wrap;gap:4px;margin-top:5px}
.tag{display:inline-flex;align-items:center;gap:3px;background:#1a2035;color:#8899cc;border-radius:999px;padding:2px 7px;font-family:var(--mono);font-size:10px}
.tag button{background:none;border:none;color:#2e3650;cursor:pointer;font-size:11px;padding:0 1px;line-height:1}
.tag button:hover{color:#f77}

.main-area{display:flex;flex-direction:column}
.main-toolbar{background:var(--card);border-bottom:1px solid var(--border);padding:8px 20px;display:flex;align-items:center;gap:10px}
.tabs{display:flex;gap:2px;background:var(--paper);border-radius:5px;padding:3px}
.tab-btn{background:none;border:none;border-radius:3px;padding:5px 14px;font-family:var(--mono);font-size:12px;font-weight:600;color:var(--ink3);cursor:pointer;transition:.15s}
.tab-btn.active{background:var(--card);color:var(--accent);box-shadow:0 1px 3px rgba(0,0,0,.08)}
.copy-btn{margin-left:auto;background:var(--paper);border:1px solid var(--border2);border-radius:4px;padding:5px 12px;font-family:var(--mono);font-size:11px;font-weight:600;color:var(--ink2);cursor:pointer;transition:.15s}
.copy-btn:hover{background:var(--accent-soft);color:var(--accent);border-color:var(--accent)}

.output-wrap{flex:1;display:flex;flex-direction:column}
.tab-content{display:none;flex:1;flex-direction:column}
.tab-content.active{display:flex}
textarea.output{flex:1;font-family:var(--mono);font-size:12px;line-height:1.75;background:var(--card);border:none;outline:none;padding:24px;resize:none;color:var(--ink);min-height:calc(100vh - 108px)}

.welcome{flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;padding:60px 40px;text-align:center;gap:14px;color:var(--ink3)}
.welcome-icon{font-size:44px;opacity:.2;line-height:1}
.welcome h2{font-size:17px;font-weight:600;color:var(--ink2)}
.welcome p{max-width:380px;font-size:13px;line-height:1.7}
.welcome code{font-family:var(--mono);background:var(--paper);border:1px solid var(--border);padding:2px 5px;border-radius:3px;font-size:11px}

@keyframes spin{to{transform:rotate(360deg)}}
.spinner{width:13px;height:13px;border:2px solid rgba(255,255,255,.3);border-top-color:#fff;border-radius:50%;animation:spin .7s linear infinite;flex-shrink:0}
</style>
</head>
<body>

<header class="site-header">
  <div class="logo">VISOR CL√çNICO<span>PRAIS ¬∑ Rayen ‚Üí LLM</span></div>
  <div class="badge">SSO ¬∑ COSAM</div>
</header>

<div class="layout">

  <aside class="sidebar">

    <!-- 01 Bookmarklet -->
    <div>
      <div class="s-label">01 ¬∑ Interceptor Rayen</div>
      <div class="bm-box">
        <a class="bm-link" id="bookmarkletLink" href="javascript:void(0)" title="Arrastra a la barra de favoritos">
          üì° Rayen Capturar
        </a>
        <div class="bm-steps">
          <div class="bm-step"><b>‚ë†</b> Arrastra el bot√≥n azul a la barra de favoritos.</div>
          <div class="bm-step"><b>‚ë°</b> Abre Rayen ‚Üí historial del paciente.</div>
          <div class="bm-step"><b>‚ë¢</b> Clic en el favorito ‚Üí panel flotante aparece.</div>
          <div class="bm-step"><b>‚ë£</b> Navega a la ficha. El interceptor captura.</div>
          <div class="bm-step"><b>‚ë§</b> Clic en <b style="color:#4477ff">"üìã Copiar datos"</b>.</div>
          <div class="bm-step"><b>‚ë•</b> Vuelve aqu√≠ y presiona el bot√≥n azul abajo.</div>
        </div>
      </div>
    </div>

    <!-- 02 Leer portapapeles -->
    <div>
      <div class="s-label">02 ¬∑ Cargar datos</div>
      <button class="btn-clipboard" id="btnClipboard">
        <span id="clipIcon">üìã</span>
        <span id="clipText">Leer desde portapapeles</span>
      </button>
      <div style="margin-top:10px">
        <div class="s-label" style="margin-bottom:5px">fallback ¬∑ pegar JSON</div>
        <textarea class="paste-area" id="pasteArea" placeholder="Pegar JSON aqu√≠ si el portapapeles falla..."></textarea>
        <button class="btn-sec" style="margin-top:5px" id="parsePaste">Parsear texto pegado</button>
      </div>
    </div>

    <div id="statusBar" class="status-bar"></div>
    <div id="counter" class="counter" style="display:none"></div>

    <!-- 03 Filtros -->
    <div>
      <div class="s-label">03 ¬∑ Filtros</div>
      <div style="display:flex;flex-direction:column;gap:8px">
        <div class="filter-group">
          <label>Instrumento</label>
          <select class="dark" id="instrumentos" multiple></select>
        </div>
        <div class="filter-group">
          <label>Profesional</label>
          <select class="dark" id="profesionales" multiple></select>
        </div>
        <div class="check-row" style="margin-top:4px">
          <input type="checkbox" id="excluirAbreviada">
          <label for="excluirAbreviada">Excluir consultas abreviadas</label>
        </div>
        <div class="check-row">
          <input type="checkbox" id="excluirVacios" checked>
          <label for="excluirVacios">Excluir registros sin anamnesis</label>
        </div>
      </div>
    </div>

    <!-- 04 Campos -->
    <div>
      <div class="s-label">04 ¬∑ Campos a incluir</div>
      <div class="fields-grid">
        <div class="check-row"><input type="checkbox" name="campo" value="Fecha" checked><label>Fecha</label></div>
        <div class="check-row"><input type="checkbox" name="campo" value="NombreCompleto" checked><label>Paciente</label></div>
        <div class="check-row"><input type="checkbox" name="campo" value="RutPaciente" checked><label>RUT</label></div>
        <div class="check-row"><input type="checkbox" name="campo" value="FechaNacimiento" checked><label>Nacimiento</label></div>
        <div class="check-row"><input type="checkbox" name="campo" value="Profesional" checked><label>Profesional</label></div>
        <div class="check-row"><input type="checkbox" name="campo" value="Diagnosticos" checked><label>Diagn√≥sticos</label></div>
        <div class="check-row"><input type="checkbox" name="campo" value="Actividades" checked><label>Actividades</label></div>
        <div class="check-row"><input type="checkbox" name="campo" value="Prescripciones" checked><label>Prescripciones</label></div>
        <div class="check-row"><input type="checkbox" name="campo" value="MotivoConsulta" checked><label>Motivo</label></div>
        <div class="check-row"><input type="checkbox" name="campo" value="Historia" checked><label>Historia</label></div>
      </div>
      <div style="margin-top:8px">
        <div style="color:#2e3650;font-size:10px;font-family:var(--mono);margin-bottom:3px">CAMPO EXTRA</div>
        <div class="add-field-row">
          <input type="text" id="campoDinamico" placeholder="ej: Indicaciones[].Texto">
          <button id="agregarCampo">+ Add</button>
        </div>
        <div class="tag-list" id="camposExtra"></div>
      </div>
    </div>

    <!-- 05 Generar -->
    <div>
      <button class="btn-primary" id="generar" disabled>‚öô Generar salida</button>
    </div>

  </aside>

  <main class="main-area">
    <div class="main-toolbar">
      <div class="tabs">
        <button class="tab-btn active" data-tab="md">Markdown</button>
        <button class="tab-btn" data-tab="json">JSON</button>
      </div>
      <button class="copy-btn" id="copyBtn">üìã Copiar</button>
    </div>
    <div class="output-wrap">
      <div id="welcome" class="welcome">
        <div class="welcome-icon">‚öï</div>
        <h2>Sin datos cargados</h2>
        <p>Instala el bookmarklet, captura el historial en Rayen con <code>üìã Copiar datos</code>, luego presiona <code>Leer desde portapapeles</code>.</p>
      </div>
      <div id="tab-md" class="tab-content active" style="display:none">
        <textarea class="output" id="outputMD" readonly></textarea>
      </div>
      <div id="tab-json" class="tab-content" style="display:none">
        <textarea class="output" id="outputJSON" readonly></textarea>
      </div>
    </div>
  </main>

</div>

<script>
const $ = id => document.getElementById(id);
const ESTADO_DX = {0:'Ninguno',1:'Sospecha',2:'Confirmada',3:'Descartada'};
let datos = [], camposExtraList = [];

/* ‚îÄ‚îÄ Utilidades ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
function formatFecha(v) {
  if (!v) return '';
  const s = (v+'').replace(/\s.*/,'');
  if (/^\d{8}$/.test(s)) return `${s.slice(6,8)}-${s.slice(4,6)}-${s.slice(0,4)}`;
  return v;
}
function formatHora(v) {
  if (!v) return '';
  const m = (v+'').match(/\d{8}\s(\d{2})(\d{2})/);
  return m ? `${m[1]}:${m[2]}` : '';
}
function getPath(obj, ruta) {
  let res = [obj];
  for (const p of ruta.split('.')) {
    const isArr = p.endsWith('[]');
    const key = isArr ? p.slice(0,-2) : p;
    res = res.flatMap(e => {
      if (!e || !(key in e)) return [];
      const val = e[key];
      if (isArr && Array.isArray(val)) return val;
      return isArr ? [] : [val];
    });
  }
  return res.filter(v => v !== undefined && v !== null && v !== '');
}
function uniq(a){ return [...new Set(a)] }
function instrDeReg(r){ return uniq(getPath(r,'Actividades[].Instrumento').concat(getPath(r,'FuncionariosPrestadores[].NombreInstrumento'))) }
function profsDeReg(r){ return uniq(getPath(r,'FuncionariosPrestadores[].NombreCompleto')) }
function setStatus(msg, tipo){ const el=$('statusBar'); el.textContent=msg; el.className='status-bar '+tipo; }
function updateCounter(t,f){ $('counter').innerHTML=`cargados <b>${t}</b> ¬∑ filtrados <b>${f}</b>`; $('counter').style.display='block'; }

/* ‚îÄ‚îÄ Bookmarklet ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
// Construido como string minificado para asignar al href
(function() {
  const code = `(function(){
function run(){
  if(window.__rayenActive){if(window.__rayenUI)window.__rayenUI.style.display='flex';return;}
  window.__rayenActive=true;window.__rayenData=[];
  var _f=window.fetch;
  window.fetch=function(){
    var a=arguments;
    return _f.apply(this,a).then(function(r){
      var url=(a[0]&&a[0].url)||a[0]||'';
      if((url+'').indexOf('HistorialAtencion')>-1){
        r.clone().json().then(function(d){
          var arr=Array.isArray(d)?d:[d];
          window.__rayenData=window.__rayenData.concat(arr);
          if(window.__rayenBadge)window.__rayenBadge.textContent=window.__rayenData.length+' reg';
        }).catch(function(){});
      }
      return r;
    });
  };
  var ui=document.createElement('div');
  window.__rayenUI=ui;
  ui.style.cssText='position:fixed;bottom:20px;right:20px;z-index:2147483647;background:#0f1117;border:2px solid #1a4fff;border-radius:10px;padding:10px 14px;font-family:monospace;font-size:12px;color:#fff;display:flex;align-items:center;gap:10px;box-shadow:0 4px 24px rgba(0,0,0,.65)';
  var lbl=document.createElement('span');lbl.style.color='#8899cc';lbl.textContent='üì° Rayen';
  var badge=document.createElement('span');
  badge.style.cssText='background:#1a4fff;padding:2px 9px;border-radius:999px;font-size:11px;font-weight:700';
  badge.textContent='0 reg';window.__rayenBadge=badge;
  var btn=document.createElement('button');
  btn.textContent='üìã Copiar datos';
  btn.style.cssText='background:#1a4fff;border:none;color:#fff;padding:6px 12px;border-radius:5px;cursor:pointer;font-family:monospace;font-size:12px;font-weight:700';
  btn.onclick=function(){
    if(!window.__rayenData.length){alert('Sin datos. Navega al historial primero.');return;}
    var compressed=LZString.compressToBase64(JSON.stringify(window.__rayenData));
    navigator.clipboard.writeText(compressed).then(function(){
      btn.textContent='‚úÖ Copiado ('+window.__rayenData.length+' reg)';
      setTimeout(function(){btn.textContent='üìã Copiar datos';},3000);
    }).catch(function(){
      window.prompt('Copia manualmente (Ctrl+A, Ctrl+C):',compressed);
    });
  };
  var x=document.createElement('button');
  x.textContent='‚úï';x.style.cssText='background:none;border:none;color:#4a5470;cursor:pointer;font-size:14px;padding:0 2px';
  x.onclick=function(){ui.style.display='none';};
  ui.appendChild(lbl);ui.appendChild(badge);ui.appendChild(btn);ui.appendChild(x);
  document.body.appendChild(ui);
}
if(window.LZString){run();}else{
  var s=document.createElement('script');
  s.src='https://cdnjs.cloudflare.com/ajax/libs/lz-string/1.4.4/lz-string.min.js';
  s.onload=run;document.head.appendChild(s);
}
})()`;
  $('bookmarkletLink').href = 'javascript:' + code.replace(/\n\s+/g,' ');
})();

/* ‚îÄ‚îÄ Parse ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
function tryDecompress(txt) {
  try {
    const dec = LZString.decompressFromBase64(txt);
    if (dec && (dec[0]==='[' || dec[0]==='{')) return dec;
  } catch(e){}
  return txt;
}

function parsear(txt, autoGenerar) {
  try {
    const source = tryDecompress(txt.trim());
    const d = JSON.parse(source);
    datos = Array.isArray(d) ? d : [d];
    poblarFiltros(datos);
    setStatus(`‚úÖ ${datos.length} registros cargados`, 'ok');
    $('counter').style.display = 'none';
    $('generar').disabled = false;
    if (autoGenerar) generar();
  } catch(e) {
    setStatus('‚ùå ' + e.message, 'err');
  }
}

function poblarFiltros(json) {
  const ins = new Set(), pros = new Set();
  json.forEach(r => { instrDeReg(r).forEach(i=>ins.add(i)); profsDeReg(r).forEach(p=>pros.add(p)); });
  const build = (sel, set) => {
    sel.innerHTML = '';
    [...set].sort().forEach(v => { const o=document.createElement('option'); o.value=o.textContent=v; sel.appendChild(o); });
  };
  build($('instrumentos'), ins);
  build($('profesionales'), pros);
}

/* ‚îÄ‚îÄ Leer portapapeles ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
$('btnClipboard').addEventListener('click', async () => {
  const icon = $('clipIcon'), txt = $('clipText'), btn = $('btnClipboard');
  icon.className = 'spinner'; icon.textContent = '';
  txt.textContent = 'Leyendo...'; btn.disabled = true;
  try {
    const raw = await navigator.clipboard.readText();
    if (!raw || !raw.trim()) throw new Error('Portapapeles vac√≠o');
    parsear(raw.trim(), true);
    icon.className=''; icon.textContent='‚úÖ';
    txt.textContent = 'Datos cargados';
    setTimeout(()=>{ icon.textContent='üìã'; txt.textContent='Leer desde portapapeles'; btn.disabled=false; }, 2500);
  } catch(e) {
    setStatus('‚ö†Ô∏è ' + (e.name==='NotAllowedError'
      ? 'Permiso denegado. Usa el fallback manual abajo.'
      : e.message), 'warn');
    icon.className=''; icon.textContent='üìã';
    txt.textContent='Leer desde portapapeles'; btn.disabled=false;
  }
});

/* ‚îÄ‚îÄ Generar ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
function generar() {
  const sel = new Set([...document.querySelectorAll('input[name="campo"]:checked')].map(c=>c.value));
  const filtInstr = [...$('instrumentos').selectedOptions].map(o=>o.value);
  const filtProfs = [...$('profesionales').selectedOptions].map(o=>o.value);
  const excluirAbr = $('excluirAbreviada').checked;
  const excluirVacios = $('excluirVacios').checked;

  const filtrados = datos.filter(r => {
    if (filtInstr.length && !instrDeReg(r).some(i=>filtInstr.includes(i))) return false;
    if (filtProfs.length && !profsDeReg(r).some(p=>filtProfs.includes(p))) return false;
    if (excluirAbr) {
      const descs = getPath(r,'Actividades[].Descripcion').map(d=>(d+'').toLowerCase());
      if (descs.some(d=>d.includes('consulta abreviada'))) return false;
    }
    if (excluirVacios) {
      const hda = getPath(r,'Anamnesis[].HistoriaEnfermedadActual').filter(x=>x&&x.trim());
      const mot = getPath(r,'Anamnesis[].MotivoConsulta').filter(x=>x&&x.trim());
      if (!hda.length && !mot.length) return false;
    }
    return true;
  });

  updateCounter(datos.length, filtrados.length);

  const porPaciente = new Map();
  filtrados.forEach(r => {
    const k = r.RutPaciente || r.NombreCompleto || '(sin paciente)';
    if (!porPaciente.has(k)) porPaciente.set(k,[]);
    porPaciente.get(k).push(r);
  });

  let md = '';
  const jsonOut = [];

  for (const [, regs] of porPaciente) {
    regs.sort((a,b)=>(a.Fecha||'').localeCompare(b.Fecha||''));
    const nombre = regs[0].NombreCompleto || '(sin nombre)';
    const rut    = regs[0].RutPaciente || '';
    const fnac   = formatFecha(regs[0].FechaNacimiento || '');

    let header = `## ${nombre}`;
    if (sel.has('RutPaciente') && rut) header += ` ¬∑ RUT ${rut}`;
    if (sel.has('FechaNacimiento') && fnac) header += ` ¬∑ Nac. ${fnac}`;
    md += header + '\n\n';

    const atenciones = [];
    regs.forEach(reg => {
      const fecha     = formatFecha(reg.Fecha||'');
      const hora      = formatHora(reg.Fecha||'');
      const profNombre= getPath(reg,'FuncionariosPrestadores[].NombreCompleto')[0]||'';
      const profProf  = getPath(reg,'FuncionariosPrestadores[].NombreInstrumento')[0]||'';
      const actDescs  = getPath(reg,'Actividades[].Descripcion');

      const dxObjs = (reg.Diagnosticos||[]).filter(d=>d.DescripcionClasificacion && d.DescripcionClasificacion!=='No Informado');
      const diagnosticos = dxObjs.map(d => {
        const est = ESTADO_DX[d.Estado];
        return (est && est!=='Ninguno') ? `${d.DescripcionClasificacion} (${est})` : d.DescripcionClasificacion;
      }).join(', ');

      const prescripciones = (reg.Prescripciones||[]).map(p=>p.Descripcion).filter(Boolean).join(' | ');
      const motivo = getPath(reg,'Anamnesis[].MotivoConsulta').join(' ');
      const hda    = getPath(reg,'Anamnesis[].HistoriaEnfermedadActual').join('\n');

      let h3 = `### ${fecha||'(sin fecha)'}`;
      if (hora) h3 += ` ${hora}`;
      if (sel.has('Profesional') && profNombre) {
        h3 += ` ‚Äî ${profNombre}`;
        if (profProf) h3 += ` (${profProf})`;
      }
      md += h3 + '\n';

      if (sel.has('Diagnosticos')   && diagnosticos)    md += `- **Dx:** ${diagnosticos}\n`;
      if (sel.has('Actividades')    && actDescs.length) md += `- **Actividades:** ${actDescs.join(', ')}\n`;
      if (sel.has('Prescripciones') && prescripciones)  md += `- **Prescripciones:** ${prescripciones}\n`;
      if (sel.has('MotivoConsulta') && motivo)          md += `- **Motivo:** ${motivo}\n`;
      if (sel.has('Historia')       && hda)             md += `- **Historia:** ${hda}\n`;

      camposExtraList.forEach(ruta => {
        const vals = getPath(reg, ruta);
        if (vals.length) md += `- **${ruta}:** ${vals.join(' | ')}\n`;
      });
      md += '\n';

      const at = {};
      if (sel.has('Fecha'))          { at.Fecha=fecha; if(hora) at.Hora=hora; }
      if (sel.has('Profesional'))    { at.Profesional=profNombre||null; at.Profesion=profProf||null; }
      if (sel.has('Diagnosticos'))   at.Diagnosticos = dxObjs.map(d=>({descripcion:d.DescripcionClasificacion, estado:ESTADO_DX[d.Estado]||''}));
      if (sel.has('Actividades'))    at.Actividades = actDescs;
      if (sel.has('Prescripciones')) at.Prescripciones = prescripciones ? prescripciones.split(' | ') : [];
      if (sel.has('MotivoConsulta')) at.MotivoConsulta = motivo||null;
      if (sel.has('Historia'))       at.Historia = hda||null;
      camposExtraList.forEach(r => { at[r]=getPath(reg,r); });
      atenciones.push(at);
    });

    jsonOut.push({NombreCompleto:nombre, RutPaciente:rut||null, FechaNacimiento:fnac||null, Atenciones:atenciones});
    md += '---\n\n';
  }

  $('outputMD').value   = md.trim();
  $('outputJSON').value = JSON.stringify(jsonOut, null, 2);
  $('welcome').style.display = 'none';
  const activeTab = document.querySelector('.tab-btn.active').dataset.tab;
  document.querySelectorAll('.tab-content').forEach(c=>c.style.display='none');
  $('tab-'+activeTab).style.display = 'flex';
}

/* ‚îÄ‚îÄ Copiar output ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
async function copiar(texto, btn) {
  try {
    await navigator.clipboard.writeText(texto);
    const orig = btn.textContent; btn.textContent='‚úÖ Copiado';
    setTimeout(()=>btn.textContent=orig, 2000);
  } catch { btn.textContent='‚ö†Ô∏è Error'; }
}

/* ‚îÄ‚îÄ Campos extra ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
function renderTags() {
  $('camposExtra').innerHTML = '';
  camposExtraList.forEach((c,i) => {
    const d=document.createElement('div'); d.className='tag';
    d.innerHTML=`${c} <button onclick="quitarCampo(${i})">‚úï</button>`;
    $('camposExtra').appendChild(d);
  });
}
window.quitarCampo = i => { camposExtraList.splice(i,1); renderTags(); };
$('agregarCampo').addEventListener('click', () => {
  const v=$('campoDinamico').value.trim();
  if (v && !camposExtraList.includes(v)){ camposExtraList.push(v); renderTags(); $('campoDinamico').value=''; }
});

/* ‚îÄ‚îÄ Eventos ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
$('parsePaste').addEventListener('click', () => {
  const t=$('pasteArea').value.trim();
  if (!t){ setStatus('‚ö†Ô∏è No hay contenido.','warn'); return; }
  parsear(t, false);
});

$('generar').addEventListener('click', generar);

$('copyBtn').addEventListener('click', () => {
  const tab = document.querySelector('.tab-btn.active').dataset.tab;
  copiar(tab==='md' ? $('outputMD').value : $('outputJSON').value, $('copyBtn'));
});

document.querySelectorAll('.tab-btn').forEach(btn => btn.addEventListener('click', () => {
  document.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('active'));
  btn.classList.add('active');
  if ($('welcome').style.display==='none') {
    document.querySelectorAll('.tab-content').forEach(c=>c.style.display='none');
    $('tab-'+btn.dataset.tab).style.display='flex';
  }
}));
</script>
</body>
</html>
